/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package mongobenchmark;

import com.mongodb.MongoClient;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import org.bson.Document;

import java.time.Duration;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;

public class App {

    public static void main(String[] args) throws InterruptedException {

        MongoClient mongoClient = new MongoClient("localhost", 27017);
        MongoCollection collection = mongoClient.getDatabase("test").getCollection("java");
        collection.drop();

        Instant start = Instant.now();

        List<Thread> threads = new ArrayList<>();
        for(int i=0; i<8; i++){
            Thread thread = new Thread(() -> {
                MongoClient mongoThreadClient = new MongoClient("localhost", 27017);

                MongoCollection threadCollection = mongoThreadClient.getDatabase("test").getCollection("java");

                for(int j=0; j<6250; j++){
                    threadCollection.insertMany(createDocuments());
                }
            });
            thread.start();
            threads.add(thread);
        }

        // Wait for all threads to finish
        for(Thread thread : threads){
            thread.join();
        }

        System.out.println("Insert took " + Duration.between(start, Instant.now()).toSeconds() + " seconds");

        start = Instant.now();
        // Now find and fetch a subset of the inserted documents
        Document document = new Document();
        document.put("author", "Isaac Asimov");

        MongoCursor<Document> cursor = collection.find(document).batchSize(1000).iterator();

        try {
            while (cursor.hasNext()) {
                Document doc = cursor.next();
                String title = doc.getString("title");
                String author = doc.getString("author");
            }
        } finally {
            cursor.close();
        }

        System.out.println("Find took " + Duration.between(start, Instant.now()).toSeconds() + " seconds");
    }

    private static List<Document> createDocuments() {
        List<Document> docs = new ArrayList<>();

        Document document = new Document();
        document.put("title", "Dune");
        document.put("author", "Frank Herbert");
        docs.add(document);

        for(int i=0; i<33; i++) {
            document = new Document();
            document.put("title", "I, Robot");
            document.put("author", "Isaac Asimov");
            docs.add(document);

            document = new Document();
            document.put("title", "Foundation");
            document.put("author", "Isaac Asimov");
            docs.add(document);

            document = new Document();
            document.put("title", "Brave New World");
            document.put("author", "Aldous Huxley");
            docs.add(document);
        }

        return docs;
    }
}
